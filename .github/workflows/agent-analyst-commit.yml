# üîç HiveMind Analyst Agent (Commit)
# Commit Comment analysis and planning
# Trigger: @analyst comment (Commit)
# Task: Analyze Commit, Create Plan, Trigger Coder

name: 'üîç Agent: Analyst (Commit)'

on:
  commit_comment:
    types: [created]

concurrency:
  group: analyst-commit-${{ github.event.comment.commit_id }}
  cancel-in-progress: false

jobs:
  analyze:
    name: 'üìä Commit Analysis'
    runs-on: ubuntu-latest
    if: |
      contains(github.event.comment.body, '@analyst') && 
      (github.event.comment.author_association == 'OWNER' || 
       github.event.comment.author_association == 'COLLABORATOR' || 
       github.event.comment.author_association == 'MEMBER')
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
      actions: write  # Required for workflow_dispatch
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install google-genai

      - name: Acknowledge & Setup Status
        id: setup
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- SWARM_STATUS_REPORT -->';
            const commitId = context.payload.comment.commit_id;
            
            // Add reaction
            await github.rest.reactions.createForCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

            const table = [
              '| Agent | Status | Task |',
              '|-------|--------|------|',
              '| üîç Analyst | ‚è≥ **WORKING** | Analysis |',
              '| ü§ñ Coder | ‚è∏Ô∏è Waiting | - |',
              '| üîé Reviewer | ‚è∏Ô∏è Waiting | - |'
            ].join('\n');

            const taskList = [
              '### üìù Task List',
              '- [/] Analysis (Analyst)',
              '- [ ] Code Changes (Coder)',
              '- [ ] Create PR (Coder)',
              '- [ ] PR Review (Reviewer)'
            ].join('\n');

            const header = `## üêù HiveMind Status Report ${marker}`;
            const body = `${header}\n\n${table}\n\n${taskList}\n\n> üîç Analyst: Analyzing request, please wait...`;

            // Just reply to the commit
            const resp = await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commitId,
                body: body
            });
            
            core.setOutput('comment_id', String(resp.data.id));
            core.setOutput('is_issue', 'false');
            core.setOutput('commit_id', String(commitId));

      - name: Run Gemini Analysis
        id: analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_NUMBER: '0'
          ISSUE_TITLE: 'Commit Comment Request'
          ISSUE_BODY: 'Request triggered via commit comment.'
          TRIGGERING_COMMENT: ${{ github.event.comment.body }}
        run: |
          python .github/scripts/swarm_analyzer.py

      - name: Post Analysis & Trigger Coder
        uses: actions/github-script@v7
        if: steps.analysis.outputs.should_proceed == 'true'
        env:
          COMMENT_ID: ${{ steps.setup.outputs.comment_id }}
          COMMIT_ID: ${{ steps.setup.outputs.commit_id }}
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('analysis_summary.md', 'utf8');
            const coderPrompt = fs.readFileSync('coder_task.txt', 'utf8');
            const commitId = process.env.COMMIT_ID;
            const commentId = process.env.COMMENT_ID;
            const marker = '<!-- SWARM_STATUS_REPORT -->';

            const table = [
              '| Agent | Status | Task |',
              '|-------|--------|------|',
              '| üîç Analyst | ‚úÖ **COMPLETED** | Analysis |',
              '| ü§ñ Coder | üöÄ **STARTING...** | Implementation |',
              '| üîé Reviewer | ‚è∏Ô∏è Waiting | - |'
            ].join('\n');

            const taskList = [
              '### üìù Task List',
              '- [x] Analysis (Analyst)',
              '- [/] Code Changes (Coder)',
              '- [ ] Create PR (Coder)',
              '- [ ] PR Review (Reviewer)'
            ].join('\n');

            const header = `## üêù HiveMind Status Report ${marker}`;
            const body = `${header}\n\n${summary}\n\n${table}\n\n${taskList}\n\n> ü§ñ Coder Agent triggered directly. Starting implementation...`;

            if (commentId) {
               await github.rest.repos.updateCommitComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: parseInt(commentId),
                  body: body
               });
            }
            
            let baseBranch = context.payload.repository.default_branch;
            
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'agent-coder.yml',
                ref: baseBranch,
                inputs: {
                  issue_number: '0',
                  coder_prompt: coderPrompt.substring(0, 65000),
                  comment_id: String(commentId),
                  base_branch: baseBranch
                }
              });
              console.log('‚úÖ Coder workflow triggered successfully!');
            } catch (dispatchError) {
              console.error('‚ùå Coder workflow could not be triggered:', dispatchError.message);
            }

      - name: Notify Failure
        if: steps.analysis.outputs.should_proceed != 'true'
        uses: actions/github-script@v7
        env:
          COMMENT_ID: ${{ steps.setup.outputs.comment_id }}
        with:
          script: |
            const commentId = process.env.COMMENT_ID;
            
            const table = [
              '| Agent | Status | Task |',
              '|-------|--------|------|',
              '| üîç Analyst | üõë **STOPPED** | Analysis |',
              '| ü§ñ Coder | üö´ Cancelled | - |'
            ].join('\n');

            const body = '## üõë Analysis Result: Stopped\n\nAnalyst Agent decided that this issue/request cannot be resolved automatically.\n\n' + table;

            if (commentId) {
               await github.rest.repos.updateCommitComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: parseInt(commentId),
                  body: body
               });
            }
